###############################################################################
###############################################################################
####                                                                       ####
####              THIS FILE WAS GENERATED WITH METASTRUCTURE               ####
####                       DO NOT EDIT IT MANUALLY!                        ####
####                                                                       ####
###############################################################################
###############################################################################

###############################################################################
###############################################################################
#### LOOKUP ACCOUNT PERMISSION SET ROLES
###############################################################################
###############################################################################

{{#each sso.reference.account_permission_sets}}
###############################################################################
# ACCOUNT: {{lodash "toUpper" (lodash "get" ../accounts (params @key "name"))}} 
###############################################################################

{{#each this}}
###############################################################################
# Permission Set: {{lodash "get" ../../sso/permission_sets (params this "name")}} 
###############################################################################
data "aws_iam_roles" "{{@../key}}_{{this}}" {
  provider = aws.{{@../key}}
  name_regex = "AWSReservedSSO_{{lodash "get" ../../sso/permission_sets (params this "name")}}_.*"
}

{{/each}}{{/each}}

###############################################################################
###############################################################################
#### GENERATE OUTPUT
###############################################################################
###############################################################################

output "accounts" {
  value = { {{#each accounts}}{{#unless action}}
    {{@key}} = {
      id = aws_organizations_account.{{@key}}.id 
      permission_set_roles = { {{#each (lodash "get" ../sso/reference/account_permission_sets @key)}}
        {{this}} = one(data.aws_iam_roles.{{@../key}}_{{this}}.names) {{/each}}
      }
    } {{/unless}}{{/each}}
  }
}

output "organization" {
  value = { 
    id = aws_organizations_organization.org.id
  }
}

output "organizational_units" {
  value = { {{#each organizational_units}}
    {{@key}} = {
      id = aws_organizations_organizational_unit.{{@key}}.id
    } {{/each}}
  }
}
