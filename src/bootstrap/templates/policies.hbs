###############################################################################
###############################################################################
####                                                                       ####
####              THIS FILE WAS GENERATED WITH METASTRUCTURE               ####
####                       DO NOT EDIT IT MANUALLY!                        ####
####                                                                       ####
###############################################################################
###############################################################################

{{#each sso.reference.account_policies}}
###############################################################################
# {{lodash "toUpper" (lookup (lookup ../accounts @key) "name")}} POLICIES
###############################################################################

{{#each this}}
###############################################################################
# Add {{lookup ../../sso/policies this}} policy to {{lookup (lookup ../../accounts @../key) "name"}}.
###############################################################################
resource "aws_iam_policy" "{{@../key}}_{{this}}" {
  name        = "{{lookup ../../sso/policies this}}"
  provider    = aws.{{@../key}}
  description = "Some description."
  policy      = data.aws_iam_policy_document.{{this}}.json
}

{{/each}}{{/each}}{{#each sso.permission_sets}}
###############################################################################
# {{lodash "toUpper" (lodash "startCase" @key)}} PERMISSION SET POLICIES
###############################################################################
{{#each this.policies}}{{#if (lookup ../../sso/policies this)}}
###############################################################################
# Add {{lookup ../../sso/policies this}} policy to {{lookup (lookup ../../sso/permission_sets @../key) 'name'}} permission set.
###############################################################################
resource "aws_ssoadmin_customer_managed_policy_attachment" "{{@../key}}_{{this}}" {
  customer_managed_policy_reference {
    name = "{{lookup ../../sso/policies this}}"
  }
  instance_arn       = local.sso_arn
  permission_set_arn = aws_ssoadmin_permission_set.permission_sets["{{@../key}}"].arn
  depends_on         = [{{#each (lookup ../../sso/reference/policy_accounts this)}}
    aws_iam_policy.{{this}}_{{@../this}}{{#unless @last}},{{/unless}}{{/each}}
  ]
}{{else}}
###############################################################################
# Add {{this}} policy to {{lookup (lookup ../../sso/permission_sets @../key) 'name'}} permission set.
###############################################################################
resource "aws_ssoadmin_managed_policy_attachment" "{{@../key}}_{{lodash "snakeCase" (lodash "startCase" this)}}" {
  managed_policy_arn = "arn:aws:iam::aws:policy/{{this}}"
  instance_arn       = local.sso_arn
  permission_set_arn = aws_ssoadmin_permission_set.permission_sets["{{@../key}}"].arn
}{{/if}}
{{/each}}{{/each}}{{#each sso.groups}}
###############################################################################
# {{lodash "toUpper" (lodash "startCase" @key)}} GROUP PERMISSION SETS
###############################################################################

{{#each this.account_permission_sets}}
###############################################################################
# Assign permission sets to {{@key}} for the {{@../key}} group.
###############################################################################
resource "aws_ssoadmin_account_assignment" "{{lodash "snakeCase" (lodash "startCase" @../key)}}_{{@key}}" {
  count              = length(module.global.config.sso.groups["{{@../key}}"].account_permission_sets["{{@key}}"])
  instance_arn       = local.sso_arn
  permission_set_arn = aws_ssoadmin_permission_set.permission_sets[module.global.config.sso.groups["{{@../key}}"].account_permission_sets["{{@key}}"][count.index]].arn
  principal_id       = aws_identitystore_group.groups["{{@../key}}"].group_id
  principal_type     = "GROUP"
  target_id          = aws_organizations_account.accounts["{{@key}}"].id
  target_type        = "AWS_ACCOUNT"
  depends_on         = [{{#each (lookup (lookup ../../sso/reference/group_account_permission_set_policies @../key) @key)}}{{#each this}}
    aws_ssoadmin_customer_managed_policy_attachment.{{ @../key}}_{{this}}{{#unless @last}},{{/unless}}{{/each}}{{#unless @last}},{{/unless}}{{/each}}
  ]
}

{{/each}}{{/each}}

